import { assert, test, beforeEach, afterEach } from 'poku';
import { cleanTestData, validateUUID, validateDate } from './setup.mjs';

console.log('üß™ Testes de Integra√ß√£o - API Sistema Completo');

// Setup do servidor para testes
let app;
let server;
const PORT = 3002; // Porta diferente para evitar conflitos

// Helper para fazer requisi√ß√µes HTTP
async function makeRequest(method, path, body = null) {
    const baseUrl = `http://localhost:${PORT}`;
    const url = `${baseUrl}${path}`;
    
    const options = {
        method: method.toUpperCase(),
        headers: {
            'Content-Type': 'application/json',
        },
    };
    
    if (body) {
        options.body = JSON.stringify(body);
    }
    
    try {
        const response = await fetch(url, options);
        const data = await response.json();
        return {
            status: response.status,
            data: data,
            ok: response.ok
        };
    } catch (error) {
        throw new Error(`Erro na requisi√ß√£o ${method} ${path}: ${error.message}`);
    }
}

// Setup e Cleanup
beforeEach(async () => {
    await cleanTestData();
    
    // Configurar servidor de teste se ainda n√£o estiver rodando
    if (!server) {
        const express = (await import('express')).default;
        const cors = (await import('cors')).default;
        const { clientRoutes, userRoutes, tabRoutes, paymentRoutes } = await import('../../src/routes/index.js');
        
        app = express();
        app.use(cors());
        app.use(express.json());
        
        // Rotas
        app.use('/api/clients', clientRoutes);
        app.use('/api/users', userRoutes);
        app.use('/api/tabs', tabRoutes);
        app.use('/api/payments', paymentRoutes);
        
        // Error handler
        app.use((err, req, res, next) => {
            console.error('Test server error:', err);
            res.status(500).json({ success: false, message: 'Internal server error' });
        });
        
        server = app.listen(PORT, () => {
            console.log(`üöÄ Servidor de teste completo rodando na porta ${PORT}`);
        });
        
        // Aguardar servidor inicializar
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
});

afterEach(async () => {
    await cleanTestData();
});

// Cleanup final
process.on('exit', () => {
    if (server) {
        server.close();
    }
});

// Teste 1: Fluxo Completo via API - Criar Usu√°rio, Cliente, Tab e Pagamento
test('Fluxo Completo via API', async () => {
    console.log('\nüß™ Teste 1: Fluxo Completo via API');
    
    // 1. Criar usu√°rio
    console.log('1Ô∏è‚É£ Criando usu√°rio via API...');
    const userResponse = await makeRequest('POST', '/api/users', {
        username: 'admin_test',
        password: 'senha123'
    });
    
    assert.strictEqual(userResponse.status, 201, 'Status deve ser 201');
    assert.strictEqual(userResponse.data.success, true, 'Resposta deve indicar sucesso');
    
    const user = userResponse.data.data;
    assert.ok(validateUUID(user.id), 'Usu√°rio deve ter ID UUID v√°lido');
    assert.strictEqual(user.username, 'admin_test', 'Username deve estar correto');
    console.log('‚úÖ Usu√°rio criado via API');
    
    // 2. Criar cliente
    console.log('2Ô∏è‚É£ Criando cliente via API...');
    const clientResponse = await makeRequest('POST', '/api/clients', {
        name: 'Jo√£o Silva',
        phone_number: '11999887766'
    });
    
    assert.strictEqual(clientResponse.status, 201, 'Status deve ser 201');
    assert.strictEqual(clientResponse.data.success, true, 'Resposta deve indicar sucesso');
    
    const client = clientResponse.data.data;
    assert.ok(validateUUID(client.id), 'Cliente deve ter ID UUID v√°lido');
    assert.strictEqual(client.name, 'Jo√£o Silva', 'Nome deve estar correto');
    console.log('‚úÖ Cliente criado via API');
    
    // 3. Criar tab
    console.log('3Ô∏è‚É£ Criando tab via API...');
    const tabResponse = await makeRequest('POST', '/api/tabs', {
        client_id: client.id,
        description: 'Compras do m√™s',
        value: '150.50',
        status: 'unpaid',
        created_by: user.id
    });
    
    assert.strictEqual(tabResponse.status, 201, 'Status deve ser 201');
    assert.strictEqual(tabResponse.data.success, true, 'Resposta deve indicar sucesso');
    
    const tab = tabResponse.data.data;
    assert.ok(validateUUID(tab.id), 'Tab deve ter ID UUID v√°lido');
    assert.strictEqual(tab.client_id, client.id, 'client_id deve estar correto');
    assert.strictEqual(tab.created_by, user.id, 'created_by deve estar correto');
    assert.strictEqual(tab.value, '150.50', 'Valor deve estar correto');
    console.log('‚úÖ Tab criada via API');
    
    // 4. Criar pagamento parcial
    console.log('4Ô∏è‚É£ Criando pagamento via API...');
    const paymentResponse = await makeRequest('POST', '/api/payments', {
        tab_id: tab.id,
        value: '50.00'
    });
    
    assert.strictEqual(paymentResponse.status, 201, 'Status deve ser 201');
    assert.strictEqual(paymentResponse.data.success, true, 'Resposta deve indicar sucesso');
    
    const payment = paymentResponse.data.data;
    assert.ok(validateUUID(payment.id), 'Pagamento deve ter ID UUID v√°lido');
    assert.strictEqual(payment.tab_id, tab.id, 'tab_id deve estar correto');
    assert.strictEqual(payment.value, '50.00', 'Valor deve estar correto');
    console.log('‚úÖ Pagamento criado via API');
    
    // 5. Verificar listagens
    console.log('5Ô∏è‚É£ Verificando listagens via API...');
    
    // Listar usu√°rios
    const usersListResponse = await makeRequest('GET', '/api/users');
    assert.strictEqual(usersListResponse.data.count, 1, 'Deve ter 1 usu√°rio');
    
    // Listar clientes
    const clientsListResponse = await makeRequest('GET', '/api/clients');
    assert.strictEqual(clientsListResponse.data.count, 1, 'Deve ter 1 cliente');
    
    // Listar tabs
    const tabsListResponse = await makeRequest('GET', '/api/tabs');
    assert.strictEqual(tabsListResponse.data.count, 1, 'Deve ter 1 tab');
    
    // Listar pagamentos
    const paymentsListResponse = await makeRequest('GET', '/api/payments');
    assert.strictEqual(paymentsListResponse.data.count, 1, 'Deve ter 1 pagamento');
    
    console.log('‚úÖ Todas as listagens funcionando');
    
    // 6. Buscar entidades por ID
    console.log('6Ô∏è‚É£ Buscando entidades por ID...');
    
    const userByIdResponse = await makeRequest('GET', `/api/users/${user.id}`);
    assert.strictEqual(userByIdResponse.status, 200, 'Usu√°rio deve ser encontrado');
    
    const clientByIdResponse = await makeRequest('GET', `/api/clients/${client.id}`);
    assert.strictEqual(clientByIdResponse.status, 200, 'Cliente deve ser encontrado');
    
    const tabByIdResponse = await makeRequest('GET', `/api/tabs/${tab.id}`);
    assert.strictEqual(tabByIdResponse.status, 200, 'Tab deve ser encontrada');
    
    const paymentByIdResponse = await makeRequest('GET', `/api/payments/${payment.id}`);
    assert.strictEqual(paymentByIdResponse.status, 200, 'Pagamento deve ser encontrado');
    
    console.log('‚úÖ Todas as buscas por ID funcionando');
    
    // 7. Atualizar entidades
    console.log('7Ô∏è‚É£ Atualizando entidades...');
    
    // Atualizar cliente
    const clientUpdateResponse = await makeRequest('PUT', `/api/clients/${client.id}`, {
        name: 'Jo√£o Santos',
        phone_number: '11888776655'
    });
    assert.strictEqual(clientUpdateResponse.status, 200, 'Cliente deve ser atualizado');
    
    // Atualizar tab
    const tabUpdateResponse = await makeRequest('PUT', `/api/tabs/${tab.id}`, {
        description: 'Compras atualizadas',
        status: 'partial'
    });
    assert.strictEqual(tabUpdateResponse.status, 200, 'Tab deve ser atualizada');
    
    console.log('‚úÖ Atualiza√ß√µes funcionando');
    
    // 8. Criar segundo pagamento para quitar
    console.log('8Ô∏è‚É£ Quitando tab...');
    const secondPaymentResponse = await makeRequest('POST', '/api/payments', {
        tab_id: tab.id,
        value: '100.50'
    });
    
    assert.strictEqual(secondPaymentResponse.status, 201, 'Segundo pagamento deve ser criado');
    
    // Atualizar status da tab para pago
    const tabPaidResponse = await makeRequest('PUT', `/api/tabs/${tab.id}`, {
        status: 'paid'
    });
    assert.strictEqual(tabPaidResponse.status, 200, 'Tab deve ser marcada como paga');
    
    console.log('‚úÖ Tab quitada com sucesso');
    
    console.log('üéâ Fluxo completo via API executado com sucesso!');
});

// Teste 2: Valida√ß√µes e Tratamento de Erros via API
test('Valida√ß√µes e Tratamento de Erros via API', async () => {
    console.log('\nüß™ Teste 2: Valida√ß√µes e Tratamento de Erros via API');
    
    // Teste cria√ß√£o de usu√°rio sem dados
    console.log('‚ùå Testando cria√ß√£o de usu√°rio sem dados...');
    const noUserDataResponse = await makeRequest('POST', '/api/users', {});
    assert.strictEqual(noUserDataResponse.status, 400, 'Status deve ser 400');
    
    // Teste cria√ß√£o de cliente sem dados
    console.log('‚ùå Testando cria√ß√£o de cliente sem dados...');
    const noClientDataResponse = await makeRequest('POST', '/api/clients', {});
    assert.strictEqual(noClientDataResponse.status, 400, 'Status deve ser 400');
    
    // Criar dados v√°lidos para pr√≥ximos testes
    const userResponse = await makeRequest('POST', '/api/users', {
        username: 'test_user',
        password: 'password123'
    });
    const user = userResponse.data.data;
    
    const clientResponse = await makeRequest('POST', '/api/clients', {
        name: 'Cliente Teste',
        phone_number: '11999887766'
    });
    const client = clientResponse.data.data;
    
    // Teste cria√ß√£o de tab sem dados obrigat√≥rios
    console.log('‚ùå Testando cria√ß√£o de tab sem dados...');
    const noTabDataResponse = await makeRequest('POST', '/api/tabs', {
        description: 'Tab incompleta'
    });
    assert.strictEqual(noTabDataResponse.status, 400, 'Status deve ser 400');
    
    // Teste cria√ß√£o de pagamento sem dados
    console.log('‚ùå Testando cria√ß√£o de pagamento sem dados...');
    const noPaymentDataResponse = await makeRequest('POST', '/api/payments', {});
    assert.strictEqual(noPaymentDataResponse.status, 400, 'Status deve ser 400');
    
    // Teste busca com IDs inexistentes
    console.log('‚ùå Testando busca com IDs inexistentes...');
    const fakeId = '123e4567-e89b-12d3-a456-426614174000';
    
    const userNotFoundResponse = await makeRequest('GET', `/api/users/${fakeId}`);
    assert.strictEqual(userNotFoundResponse.status, 404, 'Usu√°rio n√£o deve ser encontrado');
    
    const clientNotFoundResponse = await makeRequest('GET', `/api/clients/${fakeId}`);
    assert.strictEqual(clientNotFoundResponse.status, 404, 'Cliente n√£o deve ser encontrado');
    
    const tabNotFoundResponse = await makeRequest('GET', `/api/tabs/${fakeId}`);
    assert.strictEqual(tabNotFoundResponse.status, 404, 'Tab n√£o deve ser encontrada');
    
    const paymentNotFoundResponse = await makeRequest('GET', `/api/payments/${fakeId}`);
    assert.strictEqual(paymentNotFoundResponse.status, 404, 'Pagamento n√£o deve ser encontrado');
    
    console.log('‚úÖ Todas as valida√ß√µes de erro funcionando');
});

// Teste 3: Performance de API com M√∫ltiplas Requisi√ß√µes
test('Performance de API com M√∫ltiplas Requisi√ß√µes', async () => {
    console.log('\nüß™ Teste 3: Performance de API com M√∫ltiplas Requisi√ß√µes');
    
    // Criar usu√°rio base
    const userResponse = await makeRequest('POST', '/api/users', {
        username: 'performance_user',
        password: 'password123'
    });
    const user = userResponse.data.data;
    
    // Teste cria√ß√£o m√∫ltipla de clientes
    console.log('üöÄ Testando cria√ß√£o m√∫ltipla de clientes...');
    const clientPromises = [];
    const clientCount = 10;
    
    for (let i = 0; i < clientCount; i++) {
        clientPromises.push(
            makeRequest('POST', '/api/clients', {
                name: `Cliente ${i}`,
                phone_number: `1199988776${i}`
            })
        );
    }
    
    const startTime = Date.now();
    const clientResponses = await Promise.all(clientPromises);
    const endTime = Date.now();
    const duration = endTime - startTime;
    
    assert.strictEqual(clientResponses.length, clientCount, `Deve criar ${clientCount} clientes`);
    clientResponses.forEach((response, index) => {
        assert.strictEqual(response.status, 201, `Cliente ${index} deve ser criado`);
    });
    assert.ok(duration < 5000, 'Cria√ß√£o m√∫ltipla deve ser r√°pida (< 5s)');
    console.log(`‚úÖ ${clientCount} clientes criados em ${duration}ms`);
    
    // Teste listagem com m√∫ltiplos registros
    console.log('üìä Testando listagem com m√∫ltiplos registros...');
    const listStartTime = Date.now();
    const listResponse = await makeRequest('GET', '/api/clients');
    const listEndTime = Date.now();
    const listDuration = listEndTime - listStartTime;
    
    assert.strictEqual(listResponse.data.count, clientCount, `Deve listar ${clientCount} clientes`);
    assert.ok(listDuration < 1000, 'Listagem deve ser r√°pida (< 1s)');
    console.log(`‚úÖ Listagem de ${clientCount} clientes em ${listDuration}ms`);
    
    // Teste cria√ß√£o m√∫ltipla de tabs
    console.log('üìã Testando cria√ß√£o m√∫ltipla de tabs...');
    const clients = listResponse.data.data;
    const tabPromises = [];
    
    for (let i = 0; i < Math.min(clients.length, 5); i++) {
        tabPromises.push(
            makeRequest('POST', '/api/tabs', {
                client_id: clients[i].id,
                description: `Tab ${i}`,
                value: `${(i + 1) * 25}.00`,
                status: 'unpaid',
                created_by: user.id
            })
        );
    }
    
    const tabStartTime = Date.now();
    const tabResponses = await Promise.all(tabPromises);
    const tabEndTime = Date.now();
    const tabDuration = tabEndTime - tabStartTime;
    
    assert.strictEqual(tabResponses.length, 5, 'Deve criar 5 tabs');
    tabResponses.forEach((response, index) => {
        assert.strictEqual(response.status, 201, `Tab ${index} deve ser criada`);
    });
    assert.ok(tabDuration < 3000, 'Cria√ß√£o de tabs deve ser r√°pida (< 3s)');
    console.log(`‚úÖ 5 tabs criadas em ${tabDuration}ms`);
    
    console.log('‚úÖ Testes de performance de API conclu√≠dos');
});

// Teste 4: Cen√°rios de Neg√≥cio Reais
test('Cen√°rios de Neg√≥cio Reais', async () => {
    console.log('\nüß™ Teste 4: Cen√°rios de Neg√≥cio Reais');
    
    // Cen√°rio: Bar/Restaurante com m√∫ltiplos clientes e tabs
    console.log('üç∫ Simulando cen√°rio de bar/restaurante...');
    
    // Criar usu√°rio (gar√ßom/atendente)
    const waiterResponse = await makeRequest('POST', '/api/users', {
        username: 'garcom01',
        password: 'senha123'
    });
    const waiter = waiterResponse.data.data;
    
    // Criar clientes frequentes
    const regularClients = [
        { name: 'Jo√£o da Padaria', phone_number: '11999001122' },
        { name: 'Maria do Mercado', phone_number: '11999003344' },
        { name: 'Pedro Mec√¢nico', phone_number: '11999005566' }
    ];
    
    const clientPromises = regularClients.map(clientData => 
        makeRequest('POST', '/api/clients', clientData)
    );
    const clientResponses = await Promise.all(clientPromises);
    const clients = clientResponses.map(response => response.data.data);
    
    console.log(`‚úÖ ${clients.length} clientes regulares criados`);
    
    // Cen√°rio 1: Cliente com tab em aberto
    console.log('üìã Criando tabs em aberto...');
    const openTab = await makeRequest('POST', '/api/tabs', {
        client_id: clients[0].id,
        description: 'Mesa 5 - Jo√£o',
        value: '0.00', // Valor inicial zerado
        status: 'unpaid',
        created_by: waiter.id
    });
    
    // Adicionando "compras" √† tab (simulando pedidos)
    const orders = [
        { value: '15.50' }, // Cerveja
        { value: '8.00' },  // Petisco
        { value: '12.00' }  // Outra cerveja
    ];
    
    let totalTab = 0;
    for (const order of orders) {
        await makeRequest('POST', '/api/payments', {
            tab_id: openTab.data.data.id,
            value: order.value
        });
        totalTab += Number.parseFloat(order.value);
    }
    
    // Atualizar valor total da tab
    await makeRequest('PUT', `/api/tabs/${openTab.data.data.id}`, {
        value: totalTab.toFixed(2)
    });
    
    console.log(`‚úÖ Tab em aberto criada com total R$ ${totalTab.toFixed(2)}`);
    
    // Cen√°rio 2: Cliente pagando tab parcialmente
    console.log('üí∞ Simulando pagamento parcial...');
    const partialPayment = await makeRequest('POST', '/api/payments', {
        tab_id: openTab.data.data.id,
        value: '20.00'
    });
    
    await makeRequest('PUT', `/api/tabs/${openTab.data.data.id}`, {
        status: 'partial'
    });
    
    console.log('‚úÖ Pagamento parcial processado');
    
    // Cen√°rio 3: Cliente quitando tab
    console.log('‚úÖ Simulando quita√ß√£o da tab...');
    const remainingAmount = totalTab - 20.00;
    const finalPayment = await makeRequest('POST', '/api/payments', {
        tab_id: openTab.data.data.id,
        value: remainingAmount.toFixed(2)
    });
    
    await makeRequest('PUT', `/api/tabs/${openTab.data.data.id}`, {
        status: 'paid'
    });
    
    console.log('‚úÖ Tab quitada completamente');
    
    // Verificar balan√ßo final
    console.log('üìä Verificando balan√ßo final...');
    const allPayments = await makeRequest('GET', '/api/payments');
    const tabPayments = allPayments.data.data.filter(p => p.tab_id === openTab.data.data.id);
    
    const totalPaid = tabPayments.reduce((sum, payment) => sum + Number.parseFloat(payment.value), 0);
    assert.strictEqual(Number.parseFloat(totalPaid.toFixed(2)), totalTab, 'Total pago deve igualar valor da tab');
    
    console.log(`‚úÖ Balan√ßo correto: R$ ${totalPaid.toFixed(2)}`);
    
    // Cen√°rio 4: Relat√≥rio do dia
    console.log('üìà Gerando relat√≥rio do dia...');
    const allTabs = await makeRequest('GET', '/api/tabs');
    const allClientsResponse = await makeRequest('GET', '/api/clients');
    const allUsersResponse = await makeRequest('GET', '/api/users');
    
    console.log(`üìä Relat√≥rio do Dia:
    - Clientes: ${allClientsResponse.data.count}
    - Usu√°rios: ${allUsersResponse.data.count}
    - Tabs: ${allTabs.data.count}
    - Pagamentos: ${allPayments.data.count}
    - Total arrecadado: R$ ${totalPaid.toFixed(2)}`);
    
    console.log('‚úÖ Cen√°rio de neg√≥cio completo executado com sucesso');
});

console.log('üéâ Todos os testes de integra√ß√£o da API completa passaram!');
